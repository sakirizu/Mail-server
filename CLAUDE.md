# SMAIL 技術仕様書（AI向け）

> **最終更新**: 2025-12-18
> **バージョン**: 1.0.0

---

## 📌 概要

- **プロジェクト名**: SMAIL (SSM Mail System)
- **説明**: セキュアなメールアプリケーション（2FA対応、フィッシング検知機能付き）
- **技術スタック**:
  - **フロントエンド**: React Native + React Navigation 7.x
  - **バックエンド**: Node.js + Express
  - **データベース**: MySQL (ユーザー/認証) + MongoDB (メールデータ)
  - **認証**: JWT + 2FA (TOTP, WebAuthn, バックアップコード)
  - **AI機能**: Python フィッシング検知サービス (PhishTank + JPCERT/CC連携)

---

## 🏗️ アーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                    クライアント (React Native)               │
│  ├── screens/        (画面コンポーネント)                    │
│  ├── components/     (UI コンポーネント)                     │
│  ├── context/        (状態管理: AuthContext)                │
│  └── services/       (API通信)                              │
└─────────────────────────────────────────────────────────────┘
                              ↓ HTTP
┌─────────────────────────────────────────────────────────────┐
│                 バックエンド (Express.js)                    │
│  ├── server.js           (メインサーバー: ポート3001)        │
│  ├── mongoMailService.js (MongoDB メール操作)               │
│  ├── hybridMailService.js(ハイブリッドストレージ)            │
│  └── twoFactorAuth.js    (2FA認証ロジック)                  │
└─────────────────────────────────────────────────────────────┘
         ↓                              ↓
┌─────────────────────────┐      ┌─────────────────────┐
│   MySQL (ポート3306)     │      │  MongoDB (ポート27017)│
│  - users                 │      │  - mails             │
│  - user_2fa_settings     │      │  - drafts            │
│  - totp_secrets          │      │  - attachments       │
│  - backup_codes          │      │  - statistics        │
│  - webauthn_creds        │      │                      │
└─────────────────────────┘      └─────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│            フィッシング検知サービス (Python: ポート5000)      │
│  - PhishTank データベース連携 (12万件+)                      │
│  - JPCERT/CC フィッシングURLリスト連携                       │
│  - AI類似URL検出                                            │
│  - 危険度スコアリング                                        │
└─────────────────────────────────────────────────────────────┘
```

---

## 🔐 認証・認可

### JWT認証
- **シークレット**: `process.env.JWT_SECRET`
- **有効期限**: 7日間
- **ミドルウェア**: `auth()` 関数で Bearer Token を検証

### 2FA (二段階認証)
| 方式 | 実装状況 | 説明 |
|------|---------|------|
| TOTP | ✅ 完了 | Google Authenticator 等対応 |
| WebAuthn | ✅ 完了 | 生体認証/セキュリティキー |
| バックアップコード | ✅ 完了 | 10個の緊急用コード |

---

## 🛡️ フィッシング検知

### データソース
| ソース | 説明 | 更新頻度 |
|--------|------|---------|
| PhishTank | 国際的なフィッシングURLデータベース | 24時間毎 |
| JPCERT/CC | 日本向けフィッシングURLリスト | 日次更新 |

### 検出機能
1. **既知URLマッチング**: データベースとの照合
2. **類似URL検出**: 公式サイトに似せた偽URLの検出
3. **キーワード分析**: 危険なキーワードの検出
4. **危険度スコアリング**: 0-100%の信頼度スコア

---

## 📂 ディレクトリ構造

```
Mail-server/
├── App.js                    # メインエントリーポイント
├── src/
│   ├── components/           # UIコンポーネント
│   ├── screens/              # 画面コンポーネント
│   ├── context/              # 状態管理
│   └── services/             # API通信
├── backend/
│   ├── server.js             # Expressサーバー
│   ├── mongoMailService.js   # MongoDBサービス
│   ├── twoFactorAuth.js      # 2FA実装
│   └── phishing-detector/    # Python検知サービス
├── CLAUDE.md                 # この技術仕様書
└── README.md                 # 要件定義書
```

---

## ⚠️ 未実装・課題

### 優先度: 高
- [ ] JPCERT/CC フィッシングURLリスト統合
- [ ] AI類似URL検出機能
- [ ] SMTP統合（外部メール送受信）

### 優先度: 中
- [ ] ファイル添付機能
- [ ] ダークモード
- [ ] プッシュ通知

### 優先度: 低
- [ ] 連絡先管理
- [ ] メール署名
- [ ] 複数アカウント対応
