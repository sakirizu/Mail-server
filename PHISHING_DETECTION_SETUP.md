# 🛡️ フィッシング検知システム - 完全セットアップガイド

## 📋 概要

SSMail アプリケーションには **AI 搭載のフィッシング検知機能** が備わっており、すべての受信メールを自動的にチェックして以下のいずれかに振り分けます：
- ✅ **受信トレイ (INBOX)** - 安全なメール
- ⚠️ **迷惑メール (SPAM)** - フィッシングの疑いがあるメール

## 🎯 動作の仕組み

```
メールの流れ:
┌─────────────────────────────────────────────────────────────┐
│ 1. ユーザーがメールを送信                                   │
│    ↓                                                         │
│ 2. データベースに保存（送信者の「送信済み」フォルダへ）      │
│    ↓                                                         │
│ 3. 🤖 AI フィッシングチェック（Python サービス）            │
│    • PhishTank（12万件以上のフィッシングURL）との照合        │
│    • 疑わしいキーワードの分析                               │
│    • 送信者パターンの確認                                   │
│    • 信頼度スコア（0-100%）の算出                            │
│    ↓                                                         │
│ 4. 判定:                                                    │
│    ├─ フィッシング検知 → 📥 迷惑メール（SPAM）フォルダへ     │
│    └─ 安全なメール → 📬 受信トレイ（INBOX）フォルダへ       │
└─────────────────────────────────────────────────────────────┘
```

## 🚀 クイックスタート

### 方法 1: 自動（推奨）

```bash
cd backend
start-all-services.bat
```

これにより以下が自動的に実行されます：
1. ✅ Python の依存関係のインストール
2. ✅ Node.js の依存関係のインストール
3. ✅ フィッシング検知サービス（ポート 5000）の起動
4. ✅ メールサーバー（ポート 3001）の起動

### 方法 2: 手動

**ターミナル 1 - Python フィッシングデテクターの起動:**
```bash
cd backend/phishing-detector
pip install -r requirements.txt
python phishing_detector.py
```

**ターミナル 2 - メールサーバーの起動:**
```bash
cd backend
npm install
node server.js
```

## 📦 インストール要件

- ✅ **Python 3.8+** - [ダウンロード](https://www.python.org/downloads/)
- ✅ **Node.js 14+** - [ダウンロード](https://nodejs.org/)
- ✅ **MongoDB** - localhost:27017 で実行中
- ✅ **MySQL** - localhost:3306 で実行中

## 🧪 テスト方法

### フィッシングデテクターのテスト:

```bash
cd backend
node test-phishing-detection.js
```

期待される出力:
```
🧪 フィッシング検知サービスのテスト中...

テスト 1: ヘルスチェック
✅ ヘルスチェック合格
   ロードされたURL数: 120000
   最終更新: 2025-11-20T10:30:00

テスト 2: 安全なメールのチェック
   Is Phishing: false (期待値: false)
   信頼度: 0%
   推奨フォルダ: inbox

テスト 3: 疑わしいメールのチェック
   Is Phishing: true
   信頼度: 85%
   推奨フォルダ: spam

✅ すべてのテストが完了しました！
```

### アプリ内でのテスト:

1. **安全なメールを送信:**
   - 件名: "こんにちは"
   - 本文: "元気ですか？"
   - ✅ 受信者の受信用トレイ（INBOX）に表示されるはずです

2. **フィッシングメールを送信:**
   - 件名: "【緊急】アカウントの確認が必要です"
   - 本文: "こちらをクリックしてください: http://suspicious-site.com"
   - ⚠️ 受信者の迷惑メール（SPAM）フォルダに入るはずです

## 🔧 設定

### フィッシング検知の有効化/無効化

`backend/` フォルダに `.env` ファイルを作成します：

```env
# フィッシング検知を有効にするか (デフォルト: true)
ENABLE_PHISHING_DETECTION=true

# Python サービスの URL
PHISHING_DETECTOR_URL=http://localhost:5000
```

一時的に **無効** にする場合：
```env
ENABLE_PHISHING_DETECTION=false
```

## 📊 フィッシング検知基準

### 🚨 高リスク (スコア ≥ 10)
- PhishTank データベースにある既知のフィッシング URL
- → **自動的に迷惑メールとしてマーク**

### ⚠️ 疑わしい (スコア 5-9)
- 複数の疑わしいキーワード（緊急、確認、パスワード等）
- ドメインの代わりにIPアドレスがURLに含まれている
- 送信者のドメインが疑わしい
- → **迷惑メールとしてマーク**

### ✅ 安全 (スコア < 5)
- 既知のフィッシング URL なし
- 通常のキーワード
- 通常の送信者
- → **受信トレイに配信**

## 🎨 ユーザーインターフェースの更新

### サイドバーのカウント
- **下書き (Drafts):** データベースにある実際の下書き数を表示
- **迷惑メール (Spam):** データベースにある実際の迷惑メール数を表示

### 迷惑メール画面
- ✅ データベースから実際の迷惑メールを取得
- ✅ ダミーデータではなく実データを表示
- ✅ 引っ張って更新（Pull-to-refresh）に対応
- ✅ 迷惑メールがない時の空の状態を実装

## 📁 作成されたファイル

```
backend/
├── phishing-detector/
│   ├── phishing_detector.py       # メイン AI サービス
│   ├── requirements.txt            # Python 依存関係
│   ├── start.bat                   # サービス起動バッチ
│   ├── README.md                   # サービス用ドキュメント
│   └── phishtank_cache.json       # キャッシュデータ（自動生成）
├── start-all-services.bat         # 両サービスの一括起動
├── test-phishing-detection.js     # テストスイート
├── PHISHING_DETECTION_README.md   # 技術ドキュメント
└── server.js                       # フィッシングチェック統合済み
```

## 🔍 モニタリングとログ

### メールサーバーログ (server.js):

**安全なメール:**
```
🔍 フィッシングチェックを実行中...
✅ 安全なメールです → 受信トレイへ配信
📧 受信者用コピーを作成しました: user@ssm.com
```

**フィッシングメール:**
```
🔍 フィッシングチェックを実行中...
⚠️  フィッシングを検知しました (信頼度: 95%)
   理由: 既知のフィッシングURLを発見, 件名に疑わしいキーワード: 緊急
   → 迷惑メールフォルダへ配信
📧 迷惑メール用コピーを作成しました: user@ssm.com
```

## 🛠️ トラブルシューティング

### 問題: Python サービスが起動しない
**解決策:**
```bash
cd backend/phishing-detector
pip install --upgrade pip
pip install -r requirements.txt
python phishing_detector.py
```

### 問題: フィッシングデータがロードされない
**解決策:**
```bash
# キャッシュを削除して再ダウンロード
cd backend/phishing-detector
del phishtank_cache.json
python phishing_detector.py
```

## 🎉 セットアップ成功！

あなたのメールアプリケーションにエンタープライズグレードのフィッシング保護が備わりました！

- ✅ 自動フィッシング検知
- ✅ リアルタイムのメールフィルタリング
- ✅ 12万件以上の既知の有害URLをブロック
- ✅ スマートなキーワード分析
- ✅ 透明性の高い信頼度スコアリング

安全なメールライフを！ 🛡️📧
